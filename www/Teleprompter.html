<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REAPER Teleprompter</title>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --current-color: #00ff88;
      --next-color: #888888;
      --countdown-bg: #333333;
      --countdown-fill: #00ff88;
      --progress-bg: #333333;
      --progress-fill: #00ff88;
      --beat-color: #00ff88;
    }

    .light-mode {
      --bg-color: #f5f5f5;
      --text-color: #1a1a1a;
      --current-color: #007744;
      --next-color: #666666;
      --countdown-bg: #dddddd;
      --countdown-fill: #007744;
      --progress-bg: #dddddd;
      --progress-fill: #007744;
      --beat-color: #007744;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', 'Arial', sans-serif;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s, color 0.3s;
    }

    /* Public mode uses current-color for all text, not white */
    body.public-mode {
      color: var(--current-color);
    }

    /* Transparent background for OBS - uses #RRGGBBAA format where 00 alpha = transparent in OBS */
    body.transparent-bg {
      background-color: #1a1a1a00 !important;
    }

    body.transparent-bg.light-mode {
      background-color: #f5f5f500 !important;
    }

    .controls {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 100;
      display: flex;
      gap: 10px;
    }

    .controls button {
      background: var(--countdown-bg);
      color: var(--text-color);
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .controls button:hover {
      opacity: 0.8;
    }

    .controls.hidden {
      display: none;
    }

    /* Settings Panel */
    .settings-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 320px;
      height: 100%;
      background: var(--countdown-bg);
      z-index: 200;
      padding: 20px;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: 4px 0 20px rgba(0,0,0,0.3);
    }

    .settings-panel.open {
      transform: translateX(0);
    }

    .settings-panel h2 {
      margin-bottom: 20px;
      color: var(--current-color);
      font-size: 1.2rem;
    }

    .settings-group {
      margin-bottom: 20px;
    }

    .settings-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: var(--next-color);
    }

    .settings-group select,
    .settings-group input[type="number"] {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 1rem;
    }

    .settings-group input[type="checkbox"] {
      margin-right: 8px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      color: var(--text-color);
    }

    .url-output {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-color);
      border-radius: 8px;
    }

    .url-output label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: var(--next-color);
    }

    .url-output input {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background: var(--countdown-bg);
      color: var(--text-color);
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .url-output button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: var(--current-color);
      color: var(--bg-color);
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .url-output button:hover {
      opacity: 0.8;
    }

    .url-output .copied {
      text-align: center;
      color: var(--current-color);
      font-size: 0.85rem;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .url-output .copied.show {
      opacity: 1;
    }

    .settings-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 201;
      background: var(--countdown-bg);
      color: var(--text-color);
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .settings-toggle:hover {
      opacity: 0.8;
    }

    .settings-toggle.hidden {
      display: none;
    }

    .settings-panel.hidden {
      display: none;
    }

    /* Top info bar with time signature and metronome */
    .top-info {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 100;
    }

    .bpm {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--next-color);
      background: var(--countdown-bg);
      padding: 10px 15px;
      border-radius: 8px;
    }

    .time-signature {
      font-size: 2rem;
      font-weight: bold;
      color: var(--current-color);
      background: var(--countdown-bg);
      padding: 10px 20px;
      border-radius: 8px;
    }

    .metronome {
      display: flex;
      gap: 8px;
      align-items: center;
      background: var(--countdown-bg);
      padding: 10px 15px;
      border-radius: 8px;
    }

    .beat-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--progress-bg);
      transition: transform 0.05s ease-out, background-color 0.05s ease-out, box-shadow 0.05s ease-out;
    }

    .beat-indicator.active {
      background: var(--beat-color);
      transform: scale(1.3);
      box-shadow: 0 0 15px var(--beat-color);
    }

    .beat-indicator.downbeat {
      width: 24px;
      height: 24px;
    }

    .beat-indicator.downbeat.active {
      background: #ff6600;
      box-shadow: 0 0 20px #ff6600;
    }

    .top-info.hidden {
      display: none;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
      gap: 30px;
    }

    .lyrics-block {
      width: 100%;
      text-align: center;
      transition: all 0.3s ease;
    }

    .current {
      font-size: clamp(2rem, 8vw, 6rem);
      font-weight: bold;
      color: var(--current-color);
      line-height: 1.2;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    }

    .next {
      font-size: clamp(1.2rem, 4vw, 3rem);
      color: var(--next-color);
      line-height: 1.3;
      opacity: 0.7;
    }

    .next.next2 {
      font-size: clamp(1rem, 3vw, 2rem);
      opacity: 0.4;
    }

    /* Bottom bar with progress bars */
    .bottom-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      width: 80%;
      max-width: 600px;
    }

    .progress-section {
      width: 100%;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--progress-bg);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--progress-fill);
      border-radius: 4px;
      transition: width 0.1s linear;
      width: 0%;
    }

    .progress-label {
      text-align: center;
      font-size: 0.9rem;
      color: var(--next-color);
      margin-top: 5px;
    }

    /* Song progress bar */
    .song-progress .progress-bar {
      height: 12px;
    }

    .song-progress .progress-bar-fill {
      background: linear-gradient(90deg, var(--progress-fill), #00ccff);
    }

    .song-progress .progress-label {
      font-size: 1rem;
      color: var(--text-color);
    }

    .empty {
      opacity: 0.3;
      font-style: italic;
    }

    /* Public mode styles */
    .public-mode .next,
    .public-mode .bottom-bar {
      display: none;
    }

    /* Public mode top info - simplified */
    .public-mode .top-info {
      top: 20px;
      left: 20px;
    }

    .public-mode .top-info .metronome {
      display: none;
    }

    .public-mode .top-info .bpm {
      background: #33333380;
      color: var(--next-color);
      font-size: 1.2rem;
      padding: 8px 12px;
    }

    .public-mode .top-info .time-signature {
      background: #33333380;
      color: var(--current-color);
      font-size: 1.5rem;
      padding: 8px 16px;
    }

    .public-mode.light-mode .top-info .bpm {
      background: #dddddd80;
    }

    .public-mode.light-mode .top-info .time-signature {
      background: #dddddd80;
    }

    .public-mode .container {
      justify-content: center;
      overflow: hidden;
    }

    .public-mode .current.empty {
      opacity: 0;
    }

    /* Rolling lyrics container for public mode */
    .public-mode .rolling-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .public-mode .lyrics-wrapper {
      position: relative;
      width: 100%;
      text-align: center;
    }

    .public-mode .lyrics-text {
      font-size: clamp(2rem, 8vw, 6rem);
      font-weight: bold;
      color: var(--current-color);
      line-height: 1.2;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
      transition: transform 0.4s ease-out, opacity 0.4s ease-out;
    }

    .public-mode .lyrics-text.scroll-out {
      transform: translateY(-100%);
      opacity: 0;
    }

    .public-mode .lyrics-text.scroll-in {
      transform: translateY(100%);
      opacity: 0;
    }

    .public-mode .lyrics-text.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .public-mode .lyrics-text.hidden {
      opacity: 0;
      transform: translateY(0);
    }

    /* Fullscreen adjustments */
    :fullscreen .controls {
      opacity: 0;
      transition: opacity 0.3s;
    }

    :fullscreen .controls:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Settings Toggle Button -->
  <button class="settings-toggle" id="settingsToggle">Settings</button>

  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <h2>OBS Display Settings</h2>

    <div class="settings-group">
      <label>Mode</label>
      <select id="setMode">
        <option value="streamer">Streamer (full controls)</option>
        <option value="public">Public (rolling lyrics)</option>
      </select>
    </div>

    <div class="settings-group">
      <label>Theme</label>
      <select id="setTheme">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
    </div>

    <div class="settings-group">
      <label class="checkbox-label">
        <input type="checkbox" id="setTransparent" checked>
        Transparent background (for OBS)
      </label>
    </div>

    <div class="settings-group">
      <label class="checkbox-label">
        <input type="checkbox" id="setShowBpm" checked>
        Show BPM
      </label>
    </div>

    <div class="settings-group">
      <label class="checkbox-label">
        <input type="checkbox" id="setShowBeat" checked>
        Show Beat Indicator
      </label>
    </div>

    <div class="settings-group">
      <label class="checkbox-label">
        <input type="checkbox" id="setShowProgress" checked>
        Show Progress Bar
      </label>
    </div>

    <div class="url-output">
      <label>OBS Browser URL:</label>
      <input type="text" id="generatedUrl" readonly>
      <button id="copyUrl">Copy URL</button>
      <div class="copied" id="copiedMsg">Copied to clipboard!</div>
    </div>
  </div>

  <div class="controls">
    <button id="themeToggle">Light Mode</button>
    <button id="fullscreenToggle">Fullscreen</button>
  </div>

  <div class="top-info" id="topInfo">
    <div class="bpm" id="bpmDisplay">120 BPM</div>
    <div class="time-signature" id="timeSig">4/4</div>
    <div class="metronome" id="metronome">
      <!-- Beat indicators will be generated dynamically -->
    </div>
  </div>

  <!-- Streamer mode container -->
  <div class="container" id="streamerContainer">
    <div class="lyrics-block current" id="current"></div>
    <div class="lyrics-block next" id="next1"></div>
    <div class="lyrics-block next next2" id="next2"></div>
  </div>

  <!-- Public mode container (rolling lyrics) -->
  <div class="container" id="publicContainer" style="display: none;">
    <div class="rolling-container">
      <div class="lyrics-wrapper">
        <div class="lyrics-text visible" id="rollingText"></div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <!-- Song progress (based on region) -->
    <div class="progress-section song-progress">
      <div class="progress-bar">
        <div class="progress-bar-fill" id="songProgressFill"></div>
      </div>
      <div class="progress-label" id="songProgressLabel">--</div>
    </div>

  </div>

  <script src="main.js"></script>
  <script>
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode') || 'streamer';
    const theme = urlParams.get('theme') || 'dark';
    const transparent = urlParams.get('transparent') !== 'false';
    const hideSettings = urlParams.get('hideSettings') === 'true';
    const showBpm = urlParams.get('bpm') !== 'false';
    const showBeat = urlParams.get('beat') !== 'false';
    const showProgress = urlParams.get('progress') !== 'false';

    // Apply mode
    const isPublicMode = mode === 'public';
    if (isPublicMode) {
      document.body.classList.add('public-mode');
      document.querySelector('.controls').classList.add('hidden');
      document.getElementById('streamerContainer').style.display = 'none';
      document.getElementById('publicContainer').style.display = 'flex';
      if (transparent) {
        document.body.classList.add('transparent-bg');
      }
    }

    // Apply theme
    if (theme === 'light') {
      document.body.classList.add('light-mode');
      document.getElementById('themeToggle').textContent = 'Dark Mode';
    }

    // Hide settings panel/toggle if hideSettings is true
    if (hideSettings) {
      document.getElementById('settingsToggle').classList.add('hidden');
      document.getElementById('settingsPanel').classList.add('hidden');
      document.querySelector('.controls').classList.add('hidden');
    }

    // Hide BPM if disabled
    if (!showBpm) {
      document.getElementById('bpmDisplay').style.display = 'none';
    }

    // Hide beat indicator if disabled
    if (!showBeat) {
      document.getElementById('metronome').style.display = 'none';
    }

    // Hide progress bar if disabled
    if (!showProgress) {
      document.querySelector('.bottom-bar').style.display = 'none';
    }

    // Settings Panel Logic
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsToggle = document.getElementById('settingsToggle');
    const setMode = document.getElementById('setMode');
    const setTheme = document.getElementById('setTheme');
    const setTransparent = document.getElementById('setTransparent');
    const setShowBpm = document.getElementById('setShowBpm');
    const setShowBeat = document.getElementById('setShowBeat');
    const setShowProgress = document.getElementById('setShowProgress');
    const generatedUrl = document.getElementById('generatedUrl');
    const copyUrlBtn = document.getElementById('copyUrl');
    const copiedMsg = document.getElementById('copiedMsg');

    // Set initial values from current URL params
    setMode.value = mode;
    setTheme.value = theme;
    setTransparent.checked = transparent;
    setShowBpm.checked = showBpm;
    setShowBeat.checked = showBeat;
    setShowProgress.checked = showProgress;

    function generateUrl() {
      const base = window.location.origin + window.location.pathname;
      const params = new URLSearchParams();

      params.set('mode', setMode.value);
      params.set('theme', setTheme.value);
      params.set('transparent', setTransparent.checked ? 'true' : 'false');
      params.set('bpm', setShowBpm.checked ? 'true' : 'false');
      params.set('beat', setShowBeat.checked ? 'true' : 'false');
      params.set('progress', setShowProgress.checked ? 'true' : 'false');
      params.set('hideSettings', 'true');

      generatedUrl.value = base + '?' + params.toString();
    }

    // Generate URL on any change
    [setMode, setTheme, setTransparent, setShowBpm, setShowBeat, setShowProgress].forEach(el => {
      el.addEventListener('change', generateUrl);
    });

    // Initial URL generation
    generateUrl();

    // Toggle settings panel
    settingsToggle.addEventListener('click', () => {
      settingsPanel.classList.toggle('open');
    });

    // Copy URL button
    copyUrlBtn.addEventListener('click', () => {
      generatedUrl.select();
      navigator.clipboard.writeText(generatedUrl.value).then(() => {
        copiedMsg.classList.add('show');
        setTimeout(() => copiedMsg.classList.remove('show'), 2000);
      });
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', function() {
      document.body.classList.toggle('light-mode');
      this.textContent = document.body.classList.contains('light-mode') ? 'Dark Mode' : 'Light Mode';
    });

    // Fullscreen toggle
    document.getElementById('fullscreenToggle').addEventListener('click', function() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        this.textContent = 'Exit Fullscreen';
      } else {
        document.exitFullscreen();
        this.textContent = 'Fullscreen';
      }
    });

    // Elements
    const currentEl = document.getElementById('current');
    const next1El = document.getElementById('next1');
    const next2El = document.getElementById('next2');
    const timeSigEl = document.getElementById('timeSig');
    const bpmEl = document.getElementById('bpmDisplay');
    const metronomeEl = document.getElementById('metronome');
    const songProgressFill = document.getElementById('songProgressFill');
    const songProgressLabel = document.getElementById('songProgressLabel');
    const rollingTextEl = document.getElementById('rollingText');

    // State
    let currentText = '';
    let lastCurrentText = '';
    let next1Text = '';
    let next2Text = '';
    let timeSig = '4/4';
    let bpm = 120;
    let currentBeat = 1;
    let beatPos = 0;
    let playpos = 0;
    let currentEnd = 0;
    let next1Start = 0;
    let next1End = 0;
    let next2Start = 0;
    let regionStart = 0;
    let regionEnd = 0;
    let regionName = '';
    let isAnimating = false;
    let lastTimeSig = '';
    let lastBeat = 0;

    // Generate metronome beat indicators
    function generateMetronome(beatsPerMeasure) {
      metronomeEl.innerHTML = '';
      for (let i = 1; i <= beatsPerMeasure; i++) {
        const dot = document.createElement('div');
        dot.className = 'beat-indicator' + (i === 1 ? ' downbeat' : '');
        dot.id = 'beat-' + i;
        metronomeEl.appendChild(dot);
      }
    }

    // Initialize with 4/4
    generateMetronome(4);

    // Start REAPER web interface communication
    wwr_start();
    wwr_req_recur(
      "GET/PROJEXTSTATE/Teleprompter/data;TRANSPORT",
      16
    );

    function wwr_onreply(results) {
      const lines = results.split("\n");

      for (const line of lines) {
        const tok = line.split("\t");

        if (tok.length > 3 && tok[1] === "Teleprompter" && tok[2] === "data") {
          const jsonStr = tok[3] || '';
          if (jsonStr) {
            try {
              const d = JSON.parse(jsonStr);
              currentText = d.cur || '';
              next1Text = d.n1 || '';
              next2Text = d.n2 || '';
              playpos = d.pp || 0;
              currentEnd = d.ce || 0;
              next1Start = d.n1s || 0;
              next1End = d.n1e || 0;
              next2Start = d.n2s || 0;
              timeSig = d.ts || '4/4';
              bpm = d.bpm || 120;
              currentBeat = d.b || 1;
              beatPos = d.bp || 0;
              regionStart = d.rs || 0;
              regionEnd = d.re || 0;
              regionName = d.rn || '';
            } catch (e) {
              // JSON parse error, ignore
            }
          }
        }
      }

      updateDisplay();
      updateMetronome();
      updateSongProgress();
    }

    function updateDisplay() {
      // Update time signature and BPM display
      timeSigEl.textContent = timeSig;
      bpmEl.textContent = Math.round(bpm) + ' BPM';

      // Regenerate metronome if time signature changed
      if (timeSig !== lastTimeSig) {
        const parts = timeSig.split('/');
        const beatsPerMeasure = parseInt(parts[0]) || 4;
        generateMetronome(beatsPerMeasure);
        lastTimeSig = timeSig;
      }

      if (isPublicMode) {
        updatePublicDisplay();
      } else {
        updateStreamerDisplay();
      }
    }

    function updateMetronome() {
      const indicators = metronomeEl.querySelectorAll('.beat-indicator');

      // Detect beat change and trigger pulse
      if (currentBeat !== lastBeat) {
        // Remove active from all
        indicators.forEach(ind => ind.classList.remove('active'));

        // Add active to current beat
        const currentIndicator = indicators[currentBeat - 1];
        if (currentIndicator) {
          currentIndicator.classList.add('active');
          // Remove active after pulse duration
          setTimeout(() => {
            currentIndicator.classList.remove('active');
          }, 150);
        }

        lastBeat = currentBeat;
      }
    }

    function updateStreamerDisplay() {
      // Update current lyrics
      if (currentText && currentText !== '') {
        currentEl.innerHTML = currentText;
        currentEl.classList.remove('empty');
      } else {
        currentEl.innerHTML = '...';
        currentEl.classList.add('empty');
      }

      // Update next lyrics
      if (next1Text && next1Text !== '') {
        next1El.innerHTML = next1Text;
        next1El.classList.remove('empty');
      } else {
        next1El.innerHTML = '...';
        next1El.classList.add('empty');
      }

      if (next2Text && next2Text !== '') {
        next2El.innerHTML = next2Text;
        next2El.classList.remove('empty');
      } else {
        next2El.innerHTML = '...';
        next2El.classList.add('empty');
      }
    }

    function updatePublicDisplay() {
      // Check if text has changed
      if (currentText !== lastCurrentText && !isAnimating) {
        isAnimating = true;

        // If there was previous text, scroll it out
        if (lastCurrentText !== '') {
          rollingTextEl.classList.remove('visible');
          rollingTextEl.classList.add('scroll-out');

          setTimeout(() => {
            // Update text and prepare for scroll in
            if (currentText && currentText !== '') {
              rollingTextEl.innerHTML = currentText;
              rollingTextEl.classList.remove('scroll-out');
              rollingTextEl.classList.add('scroll-in');

              // Force reflow
              rollingTextEl.offsetHeight;

              // Scroll in
              setTimeout(() => {
                rollingTextEl.classList.remove('scroll-in');
                rollingTextEl.classList.add('visible');
                isAnimating = false;
              }, 50);
            } else {
              // No current text - just hide
              rollingTextEl.innerHTML = '';
              rollingTextEl.classList.remove('scroll-out');
              rollingTextEl.classList.add('hidden');
              isAnimating = false;
            }
          }, 400);
        } else {
          // No previous text - just scroll in new text
          if (currentText && currentText !== '') {
            rollingTextEl.innerHTML = currentText;
            rollingTextEl.classList.remove('hidden', 'scroll-out');
            rollingTextEl.classList.add('scroll-in');

            // Force reflow
            rollingTextEl.offsetHeight;

            setTimeout(() => {
              rollingTextEl.classList.remove('scroll-in');
              rollingTextEl.classList.add('visible');
              isAnimating = false;
            }, 50);
          } else {
            rollingTextEl.classList.add('hidden');
            isAnimating = false;
          }
        }

        lastCurrentText = currentText;
      }
    }


    function updateSongProgress() {
      if (regionEnd > regionStart && regionEnd > 0) {
        const duration = regionEnd - regionStart;
        const elapsed = playpos - regionStart;
        const progress = Math.max(0, Math.min(100, (elapsed / duration) * 100));

        songProgressFill.style.width = progress + '%';

        // Format time remaining
        const remaining = Math.max(0, regionEnd - playpos);
        const mins = Math.floor(remaining / 60);
        const secs = Math.floor(remaining % 60);
        const timeStr = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `${secs}s`;

        songProgressLabel.textContent = regionName ? `${regionName} - ${timeStr} remaining` : `${timeStr} remaining`;
      } else {
        songProgressFill.style.width = '0%';
        songProgressLabel.textContent = 'No region';
      }
    }
  </script>
</body>
</html>
