<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>REAPER Now Playing</title>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #ffffff;
      --accent-color: #00ff88;
      --secondary-color: #888888;
      --card-bg: #252525;
      --font-size: 1;
      --transition-duration: 0.5s;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', 'Arial', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.3s, color 0.3s;
    }

    body.transparent-bg { background-color: transparent !important; }

    /* Settings Toggle */
    .settings-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 201;
      background: var(--card-bg);
      color: var(--text-color);
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .settings-toggle:hover { opacity: 0.8; }
    .settings-toggle.hidden { display: none; }

    /* Settings Panel */
    .settings-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 340px;
      height: 100%;
      background: var(--card-bg);
      z-index: 200;
      padding: 20px;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: 4px 0 20px rgba(0,0,0,0.5);
    }
    .settings-panel.open { transform: translateX(0); }
    .settings-panel.hidden { display: none; }

    .settings-panel h2 {
      margin-bottom: 20px;
      color: var(--accent-color);
      font-size: 1.1rem;
    }

    .settings-panel h3 {
      margin: 20px 0 10px;
      color: var(--secondary-color);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--secondary-color);
      padding-bottom: 5px;
    }

    .settings-group {
      margin-bottom: 15px;
    }

    .settings-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.85rem;
      color: var(--secondary-color);
    }

    .settings-group select,
    .settings-group input[type="number"],
    .settings-group input[type="color"] {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 0.9rem;
    }

    .settings-group input[type="color"] {
      height: 40px;
      padding: 4px;
      cursor: pointer;
    }

    .settings-group input[type="range"] {
      width: 100%;
      cursor: pointer;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      color: var(--text-color);
      font-size: 0.9rem;
    }

    .checkbox-label input { margin-right: 8px; }

    .settings-row {
      display: flex;
      gap: 10px;
    }

    .settings-row .settings-group { flex: 1; }

    .url-output {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-color);
      border-radius: 8px;
    }

    .url-output input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: none;
      border-radius: 4px;
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 0.8rem;
    }

    .url-output button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: var(--accent-color);
      color: var(--bg-color);
      font-weight: bold;
      cursor: pointer;
    }

    .url-output .copied {
      text-align: center;
      color: var(--accent-color);
      font-size: 0.85rem;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .url-output .copied.show { opacity: 1; }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-row button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .btn-save { background: var(--accent-color); color: var(--bg-color); }
    .btn-reset { background: var(--secondary-color); color: var(--bg-color); }

    /* Background art */
    .bg-art {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      overflow: hidden;
      opacity: 0;
      transition: opacity var(--transition-duration) ease;
    }
    .bg-art.visible { opacity: 1; }

    .bg-art img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: blur(30px) brightness(0.4);
      transform: scale(1.1);
    }

    /* Now Playing container */
    .now-playing {
      display: flex;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-duration) ease;
      position: relative;
      z-index: 1;
    }
    .now-playing.visible { opacity: 1; pointer-events: auto; }

    /* Album Art */
    .album-art {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .album-art img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .album-art .no-art {
      color: var(--secondary-color);
      font-size: 3rem;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    /* Slow scroll/pan animation on album art */
    .album-art.scroll-anim img {
      animation: slowPan 20s ease-in-out infinite alternate;
    }

    @keyframes slowPan {
      0% { transform: scale(1.1) translate(0, 0); }
      25% { transform: scale(1.15) translate(-2%, -2%); }
      50% { transform: scale(1.1) translate(2%, 0); }
      75% { transform: scale(1.12) translate(0, 2%); }
      100% { transform: scale(1.1) translate(-1%, -1%); }
    }

    /* Song Info */
    .song-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .song-title {
      font-size: calc(2rem * var(--font-size));
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 8px;
      line-height: 1.2;
    }

    .song-artist {
      font-size: calc(1.4rem * var(--font-size));
      color: var(--text-color);
      margin-bottom: 4px;
    }

    .song-album {
      font-size: calc(1.1rem * var(--font-size));
      color: var(--secondary-color);
    }

    .song-year {
      font-size: calc(1rem * var(--font-size));
      color: var(--secondary-color);
      margin-top: 8px;
    }

    /* Animation classes */
    .anim-fade .now-playing { transition: opacity var(--transition-duration) ease; }

    .anim-slide-up .now-playing {
      transition: opacity var(--transition-duration) ease, transform var(--transition-duration) ease;
      transform: translateY(30px);
    }
    .anim-slide-up .now-playing.visible { transform: translateY(0); }

    .anim-slide-left .now-playing {
      transition: opacity var(--transition-duration) ease, transform var(--transition-duration) ease;
      transform: translateX(-30px);
    }
    .anim-slide-left .now-playing.visible { transform: translateX(0); }

    .anim-scale .now-playing {
      transition: opacity var(--transition-duration) ease, transform var(--transition-duration) ease;
      transform: scale(0.9);
    }
    .anim-scale .now-playing.visible { transform: scale(1); }

    .anim-none .now-playing { transition: none; }

    /* Layout: Horizontal */
    .layout-horizontal .now-playing {
      flex-direction: row;
      gap: 30px;
      max-width: 800px;
      width: 90%;
    }

    .layout-horizontal .album-art { width: 200px; height: 200px; }
    .layout-horizontal .song-info { text-align: left; }

    /* Layout: Vertical */
    .layout-vertical .now-playing {
      flex-direction: column;
      align-items: center;
      gap: 20px;
      max-width: 400px;
      width: 90%;
    }

    .layout-vertical .album-art { width: 250px; height: 250px; }
    .layout-vertical .song-info { text-align: center; }

    /* Layout: Background */
    .layout-background .now-playing {
      flex-direction: row;
      gap: 30px;
      max-width: 700px;
      width: 90%;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 16px;
      padding: 30px;
    }

    .layout-background .album-art { width: 180px; height: 180px; }
    .layout-background .song-info { text-align: left; }
    .layout-background .song-title { text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); }

    /* Layout: Minimal */
    .layout-minimal .now-playing {
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .layout-minimal .album-art { display: none; }
    .layout-minimal .song-info { text-align: center; }
  </style>
</head>
<body>
  <button class="settings-toggle" id="settingsToggle">Settings</button>

  <div class="settings-panel" id="settingsPanel">
    <h2>Now Playing Settings</h2>

    <h3>Layout</h3>
    <div class="settings-group">
      <label>Style</label>
      <select id="setLayout">
        <option value="horizontal">Horizontal</option>
        <option value="vertical">Vertical</option>
        <option value="background">Background Blur</option>
        <option value="minimal">Minimal (no art)</option>
      </select>
    </div>

    <div class="settings-group">
      <label class="checkbox-label">
        <input type="checkbox" id="setTransparent">
        Transparent background
      </label>
    </div>

    <div class="settings-row">
      <div class="settings-group">
        <label class="checkbox-label">
          <input type="checkbox" id="setShowAlbum" checked>
          Show Album
        </label>
      </div>
      <div class="settings-group">
        <label class="checkbox-label">
          <input type="checkbox" id="setShowYear" checked>
          Show Year
        </label>
      </div>
    </div>

    <div class="settings-group">
      <label class="checkbox-label">
        <input type="checkbox" id="setShowCover" checked>
        Show Cover Art
      </label>
    </div>

    <h3>Animation</h3>
    <div class="settings-group">
      <label>Transition Type</label>
      <select id="setAnimation">
        <option value="fade">Fade</option>
        <option value="slide-up">Slide Up</option>
        <option value="slide-left">Slide Left</option>
        <option value="scale">Scale</option>
        <option value="none">None</option>
      </select>
    </div>

    <div class="settings-group">
      <label>Duration: <span id="durationValue">0.5</span>s</label>
      <input type="range" id="setDuration" min="0.2" max="2" step="0.1" value="0.5">
    </div>

    <div class="settings-group">
      <label class="checkbox-label">
        <input type="checkbox" id="setScrollAnim">
        Slow pan animation on cover
      </label>
    </div>

    <div class="settings-group">
      <label>Fade Before End: <span id="fadeValue">5</span>s</label>
      <input type="range" id="setFade" min="0" max="30" step="1" value="5">
    </div>

    <h3>Colors</h3>
    <div class="settings-row">
      <div class="settings-group">
        <label>Background</label>
        <input type="color" id="setBgColor" value="#1a1a1a">
      </div>
      <div class="settings-group">
        <label>Accent</label>
        <input type="color" id="setAccentColor" value="#00ff88">
      </div>
    </div>

    <div class="settings-row">
      <div class="settings-group">
        <label>Text</label>
        <input type="color" id="setTextColor" value="#ffffff">
      </div>
      <div class="settings-group">
        <label>Secondary</label>
        <input type="color" id="setSecondaryColor" value="#888888">
      </div>
    </div>

    <h3>Typography</h3>
    <div class="settings-group">
      <label>Font Size: <span id="fontSizeValue">100</span>%</label>
      <input type="range" id="setFontSize" min="50" max="200" step="10" value="100">
    </div>

    <div class="btn-row">
      <button class="btn-save" id="saveSettings">Save</button>
      <button class="btn-reset" id="resetSettings">Reset</button>
    </div>

    <div class="url-output">
      <label style="color: var(--secondary-color); font-size: 0.85rem;">OBS URL:</label>
      <input type="text" id="generatedUrl" readonly>
      <button id="copyUrl">Copy URL</button>
      <div class="copied" id="copiedMsg">Copied!</div>
    </div>
  </div>

  <div class="bg-art" id="bgArt">
    <img id="bgArtImg" src="" alt="">
  </div>

  <div class="now-playing" id="nowPlaying">
    <div class="album-art" id="albumArt">
      <img id="albumArtImg" src="" alt="Album Art" style="display: none;">
      <span class="no-art" id="noArtIcon">&#9835;</span>
    </div>
    <div class="song-info">
      <div class="song-title" id="songTitle">--</div>
      <div class="song-artist" id="songArtist">--</div>
      <div class="song-album" id="songAlbum">--</div>
      <div class="song-year" id="songYear"></div>
    </div>
  </div>

  <script src="main.js"></script>
  <script>
    const STORAGE_KEY = 'hyd_nowplaying_settings';

    const defaults = {
      layout: 'horizontal',
      transparent: false,
      showAlbum: true,
      showYear: true,
      showCover: true,
      animation: 'fade',
      duration: 0.5,
      scrollAnim: false,
      fade: 5,
      bgColor: '#1a1a1a',
      accentColor: '#00ff88',
      textColor: '#ffffff',
      secondaryColor: '#888888',
      fontSize: 100
    };

    function loadSettings() {
      const urlParams = new URLSearchParams(window.location.search);
      const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

      return {
        layout: urlParams.get('layout') || stored.layout || defaults.layout,
        transparent: urlParams.has('transparent') ? urlParams.get('transparent') === 'true' : (stored.transparent ?? defaults.transparent),
        showAlbum: urlParams.has('album') ? urlParams.get('album') !== 'false' : (stored.showAlbum ?? defaults.showAlbum),
        showYear: urlParams.has('year') ? urlParams.get('year') !== 'false' : (stored.showYear ?? defaults.showYear),
        showCover: urlParams.has('cover') ? urlParams.get('cover') !== 'false' : (stored.showCover ?? defaults.showCover),
        animation: urlParams.get('anim') || stored.animation || defaults.animation,
        duration: parseFloat(urlParams.get('dur')) || stored.duration || defaults.duration,
        scrollAnim: urlParams.has('scroll') ? urlParams.get('scroll') === 'true' : (stored.scrollAnim ?? defaults.scrollAnim),
        fade: parseInt(urlParams.get('fade')) ?? stored.fade ?? defaults.fade,
        bgColor: urlParams.get('bg') || stored.bgColor || defaults.bgColor,
        accentColor: urlParams.get('accent') || stored.accentColor || defaults.accentColor,
        textColor: urlParams.get('text') || stored.textColor || defaults.textColor,
        secondaryColor: urlParams.get('secondary') || stored.secondaryColor || defaults.secondaryColor,
        fontSize: parseInt(urlParams.get('size')) || stored.fontSize || defaults.fontSize,
        hideSettings: urlParams.get('hideSettings') === 'true'
      };
    }

    let settings = loadSettings();

    // Elements
    const settingsPanel = document.getElementById('settingsPanel');
    const settingsToggle = document.getElementById('settingsToggle');
    const nowPlayingEl = document.getElementById('nowPlaying');
    const albumArtEl = document.getElementById('albumArt');
    const albumArtImg = document.getElementById('albumArtImg');
    const noArtIcon = document.getElementById('noArtIcon');
    const bgArt = document.getElementById('bgArt');
    const bgArtImg = document.getElementById('bgArtImg');
    const songTitleEl = document.getElementById('songTitle');
    const songArtistEl = document.getElementById('songArtist');
    const songAlbumEl = document.getElementById('songAlbum');
    const songYearEl = document.getElementById('songYear');

    // Settings inputs
    const inputs = {
      layout: document.getElementById('setLayout'),
      transparent: document.getElementById('setTransparent'),
      showAlbum: document.getElementById('setShowAlbum'),
      showYear: document.getElementById('setShowYear'),
      showCover: document.getElementById('setShowCover'),
      animation: document.getElementById('setAnimation'),
      duration: document.getElementById('setDuration'),
      scrollAnim: document.getElementById('setScrollAnim'),
      fade: document.getElementById('setFade'),
      bgColor: document.getElementById('setBgColor'),
      accentColor: document.getElementById('setAccentColor'),
      textColor: document.getElementById('setTextColor'),
      secondaryColor: document.getElementById('setSecondaryColor'),
      fontSize: document.getElementById('setFontSize')
    };

    function applySettings() {
      const root = document.documentElement;
      root.style.setProperty('--bg-color', settings.bgColor);
      root.style.setProperty('--accent-color', settings.accentColor);
      root.style.setProperty('--text-color', settings.textColor);
      root.style.setProperty('--secondary-color', settings.secondaryColor);
      root.style.setProperty('--font-size', settings.fontSize / 100);
      root.style.setProperty('--transition-duration', settings.duration + 's');

      // Layout
      document.body.className = document.body.className.replace(/layout-\w+/g, '').replace(/anim-[\w-]+/g, '');
      document.body.classList.add('layout-' + settings.layout);
      document.body.classList.add('anim-' + settings.animation);
      document.body.classList.toggle('transparent-bg', settings.transparent);

      // Scroll animation
      albumArtEl.classList.toggle('scroll-anim', settings.scrollAnim);

      // Visibility
      songAlbumEl.style.display = settings.showAlbum ? '' : 'none';
      songYearEl.style.display = settings.showYear ? '' : 'none';
      albumArtEl.style.display = settings.showCover ? '' : 'none';

      if (settings.hideSettings) {
        settingsToggle.classList.add('hidden');
        settingsPanel.classList.add('hidden');
      }

      // Update inputs
      inputs.layout.value = settings.layout;
      inputs.transparent.checked = settings.transparent;
      inputs.showAlbum.checked = settings.showAlbum;
      inputs.showYear.checked = settings.showYear;
      inputs.showCover.checked = settings.showCover;
      inputs.animation.value = settings.animation;
      inputs.duration.value = settings.duration;
      inputs.scrollAnim.checked = settings.scrollAnim;
      inputs.fade.value = settings.fade;
      inputs.bgColor.value = settings.bgColor;
      inputs.accentColor.value = settings.accentColor;
      inputs.textColor.value = settings.textColor;
      inputs.secondaryColor.value = settings.secondaryColor;
      inputs.fontSize.value = settings.fontSize;

      document.getElementById('durationValue').textContent = settings.duration;
      document.getElementById('fadeValue').textContent = settings.fade;
      document.getElementById('fontSizeValue').textContent = settings.fontSize;
    }

    function readSettings() {
      settings.layout = inputs.layout.value;
      settings.transparent = inputs.transparent.checked;
      settings.showAlbum = inputs.showAlbum.checked;
      settings.showYear = inputs.showYear.checked;
      settings.showCover = inputs.showCover.checked;
      settings.animation = inputs.animation.value;
      settings.duration = parseFloat(inputs.duration.value);
      settings.scrollAnim = inputs.scrollAnim.checked;
      settings.fade = parseInt(inputs.fade.value);
      settings.bgColor = inputs.bgColor.value;
      settings.accentColor = inputs.accentColor.value;
      settings.textColor = inputs.textColor.value;
      settings.secondaryColor = inputs.secondaryColor.value;
      settings.fontSize = parseInt(inputs.fontSize.value);
    }

    function generateUrl() {
      const base = window.location.origin + window.location.pathname;
      const p = new URLSearchParams();
      p.set('layout', settings.layout);
      p.set('transparent', settings.transparent);
      p.set('album', settings.showAlbum);
      p.set('year', settings.showYear);
      p.set('cover', settings.showCover);
      p.set('anim', settings.animation);
      p.set('dur', settings.duration);
      p.set('scroll', settings.scrollAnim);
      p.set('fade', settings.fade);
      p.set('bg', settings.bgColor);
      p.set('accent', settings.accentColor);
      p.set('text', settings.textColor);
      p.set('secondary', settings.secondaryColor);
      p.set('size', settings.fontSize);
      p.set('hideSettings', 'true');
      document.getElementById('generatedUrl').value = base + '?' + p.toString();
    }

    // Event listeners
    Object.values(inputs).forEach(input => {
      input.addEventListener('change', () => { readSettings(); applySettings(); generateUrl(); });
      input.addEventListener('input', () => { readSettings(); applySettings(); generateUrl(); });
    });

    settingsToggle.addEventListener('click', () => settingsPanel.classList.toggle('open'));

    document.getElementById('saveSettings').addEventListener('click', () => {
      readSettings();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
      alert('Settings saved!');
    });

    document.getElementById('resetSettings').addEventListener('click', () => {
      if (confirm('Reset all settings to defaults?')) {
        localStorage.removeItem(STORAGE_KEY);
        settings = { ...defaults };
        applySettings();
        generateUrl();
      }
    });

    document.getElementById('copyUrl').addEventListener('click', () => {
      const url = document.getElementById('generatedUrl');
      url.select();
      navigator.clipboard.writeText(url.value).then(() => {
        const msg = document.getElementById('copiedMsg');
        msg.classList.add('show');
        setTimeout(() => msg.classList.remove('show'), 2000);
      });
    });

    // Initialize
    applySettings();
    generateUrl();

    // State
    let displayActive = false, lastDisplayActive = false;
    let title = '', artist = '', album = '', year = '', cover = '', lastCover = '', lastTitle = '';
    let timeRemaining = 0, isVisible = false;
    let regionName = '', lastRegionName = '';

    // REAPER communication
    wwr_start();
    wwr_req_recur("GET/PROJEXTSTATE/NowPlaying/data;TRANSPORT", 50);

    function wwr_onreply(results) {
      for (const line of results.split("\n")) {
        const tok = line.split("\t");
        if (tok.length > 3 && tok[1] === "NowPlaying" && tok[2] === "data") {
          try {
            const d = JSON.parse(tok[3] || '{}');
            displayActive = d.d || false;
            title = d.t || '';
            artist = d.a || '';
            album = d.al || '';
            year = d.y || '';
            cover = d.c || '';
            timeRemaining = d.tr || 0;
            regionName = d.rn || '';
            playPos = d.pp || 0;
            itemStart = d.is || 0;
            itemEnd = d.ie || 0;
          } catch (e) {}
        }
      }
      updateDisplay();
    }

    function updateDisplay() {
      const hasContent = displayActive && (title || regionName);
      const contentChanged = regionName !== lastRegionName || title !== lastTitle;

      // Simple logic: if we have content to show, show it
      if (hasContent) {
        if (!isVisible) {
          show();
        } else if (contentChanged) {
          // Content changed while visible - update immediately
          updateContent();
        }
      } else {
        // No content - fade out
        if (isVisible) {
          fadeOut();
        }
      }

      // Fade near end of item/region
      if (hasContent && isVisible && timeRemaining > 0 && timeRemaining <= settings.fade) {
        const opacity = timeRemaining / settings.fade;
        nowPlayingEl.style.opacity = opacity;
        if (settings.layout === 'background') bgArt.style.opacity = opacity;
      }

      lastDisplayActive = displayActive;
      lastRegionName = regionName;
      lastTitle = title;

      if (isVisible) updateContent();
    }

    function show() {
      isVisible = true;
      updateContent();
      nowPlayingEl.style.opacity = '';
      nowPlayingEl.classList.add('visible');
      if (settings.layout === 'background' && cover) {
        bgArt.classList.add('visible');
      }
    }

    function fadeOut() {
      if (!isVisible) return;
      nowPlayingEl.classList.remove('visible');
      nowPlayingEl.style.opacity = '';
      if (settings.layout === 'background') {
        bgArt.classList.remove('visible');
      }
      setTimeout(() => {
        isVisible = false;
        lastCover = '';
      }, settings.duration * 1000);
    }

    function updateContent() {
      songTitleEl.textContent = title || '--';
      songArtistEl.textContent = artist || '--';
      songAlbumEl.textContent = album || '--';
      songYearEl.textContent = year || '';

      if (cover && cover !== lastCover) {
        // Preload image before showing
        const imgUrl = cover + '?t=' + Date.now();
        preloadImage(imgUrl, () => {
          // Only show if this is still the current cover
          if (cover === lastCover || imgUrl.startsWith(cover)) {
            albumArtImg.src = imgUrl;
            albumArtImg.style.display = 'block';
            noArtIcon.style.display = 'none';
            if (settings.layout === 'background') {
              bgArtImg.src = imgUrl;
              bgArt.classList.add('visible');
            }
          }
        }, () => {
          // Error loading - show placeholder
          albumArtImg.style.display = 'none';
          noArtIcon.style.display = 'flex';
        });
        lastCover = cover;
      } else if (!cover) {
        albumArtImg.style.display = 'none';
        noArtIcon.style.display = 'flex';
        if (settings.layout === 'background') {
          bgArt.classList.remove('visible');
        }
        lastCover = '';
      }
    }

    // Preload image and call callback when ready
    function preloadImage(url, onLoad, onError) {
      const img = new Image();
      img.onload = onLoad;
      img.onerror = onError || (() => {});
      img.src = url;
    }

    albumArtImg.onerror = function() {
      this.style.display = 'none';
      noArtIcon.style.display = 'flex';
    };

    bgArtImg.onerror = function() {
      bgArt.classList.remove('visible');
    };
  </script>
</body>
</html>
